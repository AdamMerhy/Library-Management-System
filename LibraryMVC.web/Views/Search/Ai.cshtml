@model LibraryMVC.web.ViewModels.AiSearchViewModel
@{
    ViewData["Title"] = "AI Search";
}

<div class="form-page">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold mb-0">üîç AI-Powered Search</h2>
        <a asp-controller="Books" asp-action="Index" class="btn btn-outline-secondary">‚Üê Back to Books</a>
    </div>

    <div class="card p-4 mb-4">
        <form method="get" asp-action="Ai">
            <label class="form-label fw-semibold">Describe the books you're looking for</label>
            <div class="d-flex gap-2">
                <input type="text" name="prompt" value="@Model.Prompt" class="form-control"
                       placeholder="e.g. Science fiction books by Isaac Asimov published after 1970"
                       autofocus />
                <button type="submit" class="btn btn-primary text-nowrap">Search</button>
            </div>
            <span asp-validation-for="Prompt" class="text-danger small"></span>
        </form>
    </div>

    @if (Model.Explanation is not null)
    {
        <div class="filter-bar d-flex align-items-start gap-3 mb-4">
            <div>
                <span class="fw-semibold">AI understood:</span>
                <span class="text-muted">@Model.Explanation</span>
                @if (Model.UsedFallback)
                {
                    <span class="badge bg-warning text-dark ms-2">Fallback</span>
                }
            </div>
        </div>

        @if (Model.ParsedFilters is not null)
        {
            <div class="mb-3 d-flex flex-wrap gap-2">
                @if (!string.IsNullOrWhiteSpace(Model.ParsedFilters.Title))
                {
                    <span class="badge badge-category">Title: @Model.ParsedFilters.Title</span>
                }
                @if (!string.IsNullOrWhiteSpace(Model.ParsedFilters.Author))
                {
                    <span class="badge badge-category">Author: @Model.ParsedFilters.Author</span>
                }
                @if (!string.IsNullOrWhiteSpace(Model.ParsedFilters.Category))
                {
                    <span class="badge badge-category">Category: @Model.ParsedFilters.Category</span>
                }
                @if (Model.ParsedFilters.PublishYearMin.HasValue)
                {
                    <span class="badge badge-category">From: @Model.ParsedFilters.PublishYearMin</span>
                }
                @if (Model.ParsedFilters.PublishYearMax.HasValue)
                {
                    <span class="badge badge-category">To: @Model.ParsedFilters.PublishYearMax</span>
                }
                @if (Model.ParsedFilters.AvailableOnly == true)
                {
                    <span class="badge badge-available">Available only</span>
                }
                @if (Model.ParsedFilters.Keywords is { Count: > 0 })
                {
                    @foreach (var kw in Model.ParsedFilters.Keywords)
                    {
                        <span class="badge badge-category">@kw</span>
                    }
                }
            </div>
        }
    }

    @if (Model.Results.Count > 0)
    {
        <p class="text-muted mb-3">@Model.Results.Count book(s) found</p>

        <div class="book-grid">
            @foreach (var book in Model.Results)
            {
                <a asp-controller="Books" asp-action="Details" asp-route-id="@book.Id"
                   class="book-card text-decoration-none text-reset">
                    <div class="book-card-cover-wrapper">
                        @if (!string.IsNullOrWhiteSpace(book.CoverImageUrl))
                        {
                            <img src="@book.CoverImageUrl" alt="@book.Title" class="book-card-cover" />
                        }
                        else
                        {
                            <div class="cover-placeholder">üìñ</div>
                        }
                    </div>
                    <div class="book-card-body">
                        <div class="book-card-title">@book.Title</div>
                        <div class="book-card-author">@book.Author</div>
                        @if (!string.IsNullOrWhiteSpace(book.Category))
                        {
                            <span class="badge badge-category mb-2 align-self-start">@book.Category</span>
                        }
                        <div class="book-card-meta">
                            @if (book.PublishYear.HasValue)
                            {
                                <small class="text-muted">@book.PublishYear</small>
                            }
                            <span class="badge @(book.AvailableCopies > 0 ? "badge-available" : "badge-unavailable")">
                                @book.AvailableCopies / @book.TotalCopies
                            </span>
                        </div>
                    </div>
                </a>
            }
        </div>
    }
    else if (Model.Explanation is not null)
    {
        <div class="alert alert-info">No books found matching your query. Try different terms.</div>
    }
</div>